# Tasks: Refine Build and Test Configuration

This is an ordered list of tasks to implement the unified build and test configuration.

### Phase 1: Storybook and Vitest Integration

*   [x] **1. Install Storybook-Vitest Addon**: Run the automatic installer to add and configure `@storybook/addon-vitest`.
    - `npx storybook add @storybook/addon-vitest`
    - *Validation*: Verify that `package.json` is updated, `.storybook/main.ts` includes the addon, and `.storybook/vitest.setup.ts` is created.

*   [x] **2. Install Playwright Dependencies**: When prompted by the previous step, install the necessary Playwright browser binaries.
    - *Validation*: Confirm that browser binaries are downloaded successfully.

### Phase 2: TypeScript Configuration Refactor

*   [x] **3. Create `tsconfig.base.json`**:
    - Create a new `tsconfig.base.json` file.
    - Move all path aliases and common `compilerOptions` from the root `tsconfig.json` into this new base file.

*   [x] **4. Refactor Existing `tsconfig.json` Files**:
    - Modify the root `tsconfig.json` to `extends` `./tsconfig.base.json`.
    - Modify `src/main/tsconfig.json`, `src/renderer/tsconfig.json`, `src/preload/tsconfig.json` to extend `../../tsconfig.base.json` and remove any redundant path alias definitions.
    - Modify `tsconfig.playwright.json` to extend `./tsconfig.base.json`.

*   [x] **5. Update `tsconfig.vitest.json`**:
    - Modify `tsconfig.vitest.json` to extend `./tsconfig.base.json`.
    - Update its `compilerOptions.types` to include `vitest/globals`, `vitest/jsdom`, and `vitest/browser`.
    - Update its `include` array to cover all necessary files for type-checking during tests, as defined in the spec.

### Phase 3: Vitest Configuration

*   [x] **6. Refactor `vitest.config.ts`**:
    - Modify `vitest.config.ts` to use the `projects` architecture.
    - Define the `main` project with a `node` environment.
    - Define the `renderer` project with a `jsdom` environment.
    - Integrate the configuration generated by `@storybook/addon-vitest` as the `storybook` project, ensuring it uses the `browser` environment and the `storybookTest` plugin.

*   [x] **7. Add Storybook Test Script**:
    - Add `"test:storybook": "vitest --project storybook"` to the `scripts` section of `package.json`.
    - *Validation*: Run `npm run test:storybook` and verify that it executes only the Storybook-related tests.

### Phase 4: Vite Configuration Refactor

*   [x] **10. Create `vite.base.config.mts`**: Create a new base Vite configuration file for shared plugins.
    - *Validation*: File exists and contains `tsconfigPaths()`.

*   [x] **11. Refactor `vite.main.config.mts`**: Update to use `mergeConfig` with `vite.base.config.mts`.
    - *Validation*: File uses `mergeConfig` and imports `baseConfig`.

*   [x] **12. Refactor `vite.preload.config.mts`**: Update to use `mergeConfig` with `vite.base.config.mts`.
    - *Validation*: File uses `mergeConfig` and imports `baseConfig`.

*   [x] **13. Refactor `vite.renderer.config.mts`**: Update to use `mergeConfig` with `vite.base.config.mts` and remove redundant `tsconfigPaths()` plugin.
    - *Validation*: File uses `mergeConfig`, imports `baseConfig`, and `tsconfigPaths()` is removed from its `plugins` array.

*   [x] **14. Validate Vite Configuration**: Ensure the build still works after refactoring.
    - *Validation*: Run `pnpm make` and confirm the Electron application builds successfully.

### Phase 5: Validation

*   [x] **15. Run All Tests**:
    - Execute `pnpm test:all` to run all test projects (`main`, `renderer`, `storybook`) and Playwright E2E tests, confirming they all pass.
    - *Validation*: All tests pass without any type errors.

*   [x] **16. Validate Type Checking**:
    - Run `npx tsc --noEmit -p tsconfig.json` to ensure the overall project still type-checks correctly from the IDE's perspective.
    - *Validation*: The command completes without errors.
